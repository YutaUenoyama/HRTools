# HRTool VBAコード最適化内容と使用方法

## 問題の原因

問題のファイル `20260101新従業員名簿.xlsx` の「退職者」シートが**最大列16,367列**という異常な値になっていました。
元のコードでは `UsedRange.Value` を使用していたため、約**376万セル**を読み込もうとしてしまい、処理が終わらない状態になっていました。

## 主な最適化内容

### 1. 実際のデータ範囲の検出（最重要）
- `UsedRange` の代わりに `Cells.Find()` で実際の最終行・最終列を検出
- 異常な範囲を検出した場合は上限で制限（行:10,000、列:200）
- セル数が50万を超える場合は警告を表示し、500行に制限

```vba
Private Const MAX_DATA_ROWS As Long = 10000  ' 最大行数制限
Private Const MAX_DATA_COLS As Long = 200    ' 最大列数制限
```

### 2. パフォーマンス最適化
- `Application.Calculation = xlCalculationManual` で自動計算を無効化
- `Application.EnableEvents = False` でイベント処理を無効化
- `Application.ScreenUpdating = False` で画面更新を無効化
- マクロを無効化して安全にファイルを開く: `Application.AutomationSecurity = msoAutomationSecurityForceDisable`

### 3. 氏名での代替処理（新機能）
- 社員番号がないファイルでも、**氏名**列があれば処理可能
- 氏名を社員番号として扱い、データを統合
- 氏名列はそのまま保持されます

### 4. 進捗表示
- `Application.StatusBar` でファイル/シートの処理状況を表示
- ユーザーに何が処理されているか分かりやすく表示

### 5. エラーハンドリングの強化
- 各ファイル・シートでエラーが発生しても処理を継続
- エラーメッセージを `Debug.Print` で出力（イミディエイトウィンドウで確認可能）
- 最終的にエラーが発生した場合は詳細なメッセージボックスを表示

### 6. メモリ効率の改善
- KEY_EMP()などの辞書オブジェクトを`Static`変数として1度だけ作成
- 不要な変数を適切にクリア

### 7. その他の改善
- `On Error Resume Next` の範囲を最小限に限定
- 各関数にエラーハンドラを追加
- 完了時に処理したシート数を表示

## データの識別ロジック

HRToolは以下の優先順位でデータを識別します：

1. **社員番号**列がある → 社員番号で管理
2. **社員番号**列がなく**氏名**列がある → 氏名を社員番号として扱う
3. どちらもない → そのシートはスキップ（エラーにはならない）

### 例

| ケース | 社員番号列 | 氏名列 | 処理 |
|--------|-----------|--------|------|
| A | ○ | ○ | 社員番号で管理 |
| B | × | ○ | 氏名を社員番号として扱う |
| C | ○ | × | 社員番号で管理 |
| D | × | × | スキップ |

**注意**: 氏名で管理する場合、同姓同名の社員がいると1人にまとめられてしまいます。その場合は事前に社員番号列を追加することをお勧めします。

## VBAコードのインポート手順

### 方法1: VBAエディタで直接コピー&ペースト（推奨）

1. HRTool.xlsm を開く
2. `Alt + F11` を押してVBAエディタを開く
3. 左側のプロジェクトエクスプローラーで `HRTool.xlsm` の `Module1` をダブルクリック
4. 既存のコードをすべて選択して削除（`Ctrl + A` → `Delete`）
5. `VBA.txt` の内容をすべてコピー
6. VBAエディタにペースト（`Ctrl + V`）
7. `Ctrl + S` で保存
8. VBAエディタを閉じる（`Alt + Q`）

### 方法2: モジュールのインポート

1. HRTool.xlsm を開く
2. `Alt + F11` を押してVBAエディタを開く
3. 既存の `Module1` を右クリック → 削除（エクスポートするか聞かれたら「いいえ」）
4. メニューバーから `ファイル` → `ファイルのインポート`
5. `VBA.txt` を選択（拡張子を `.bas` に変更する必要があるかもしれません）
6. `Ctrl + S` で保存

### 注意事項

- **必ずバックアップを作成してください**（元のファイルは `VBA_backup.txt` として保存済み）
- インポート後、マクロのセキュリティ設定で「すべてのマクロを有効にする」を選択する必要があります

## 動作確認

1. HRTool.xlsm を開く
2. ボタン「複数シートを1枚に集約」または「追加のExcelシートを統合」をクリック
3. 問題のファイル `20260101新従業員名簿.xlsx` を選択
4. 処理が開始され、ステータスバーに進捗が表示されるはずです
5. 処理完了後、「完了しました。X 個のシートを処理しました。」というメッセージが表示されます

## トラブルシューティング

### 処理が遅い場合
- 最初のファイル処理時は、Excelの初期化に時間がかかる場合があります
- 大量のファイルを処理する場合は、数分かかることがあります
- ステータスバーで進捗を確認してください

### エラーが表示される場合
1. VBAエディタを開く（`Alt + F11`）
2. メニューバーから `表示` → `イミディエイトウィンドウ`（または `Ctrl + G`）
3. エラーメッセージが表示されているか確認
4. エラー内容を確認して対処

### マクロが実行できない場合
1. Excelのオプション → `トラストセンター` → `トラストセンターの設定`
2. `マクロの設定` → `すべてのマクロを有効にする` を選択
3. または `VBAプロジェクトオブジェクトモデルへのアクセスを信頼する` にチェック

## 処理速度の目安

- 小規模ファイル（1,000行以内）: 数秒
- 中規模ファイル（1,000-5,000行）: 10-30秒
- 大規模ファイル（5,000行以上）: 30秒-数分
- 複数ファイルの場合は、ファイル数 × 上記の目安

## ファイル構成

```
人事管理ツール/
├── HRTool.xlsm                 # メインのExcelファイル
├── VBA.txt                     # 最適化されたVBAコード（最新版）
├── VBA_backup.txt              # 元のVBAコードのバックアップ
├── VBA_optimized.txt           # 最適化版のコピー（VBA.txtと同じ内容）
├── 最適化内容と使用方法.md      # このファイル
└── input/                      # テスト用のExcelファイル
    ├── 20260101新従業員名簿.xlsx
    ├── 202408.xlsx
    └── ...
